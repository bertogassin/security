# Архитектура Security: гибкая и гибридная

Приложение рассчитано на масштаб: верификация, документы, мультиязычность, безопасность аккаунта. Файлы не перегружаем — каждый домен/фича живёт в своём слое, стыковка через контракты (типы, API).

---

## 1. Принципы

| Принцип | Как соблюдаем |
|--------|----------------|
| **Гибридность** | Frontend (SolidJS, **TS только для UI**) + Backend (**Rust**, приоритет) + мобильное оболочка (Capacitor). Домены могут иметь свой слой (API, типы, UI-слайс). |
| **Без перегруза файлов** | Один экран/фича — один или несколько мелких модулей. Общая логика — в `shared`/`domains`, не в гигантских страницах. |
| **Языки с первого дня** | i18n заложен в архитектуру: ключи по доменам, ленивая подгрузка локалей, одна точка смены языка. |
| **Верификация и документы** | Отдельный домен: типы, статусы, загрузка фото/документов, дипломы. Не смешивать с «профилем» и «заказами». |

---

## 2. Структура по слоям (гибрид)

```
security/
├── apps/web/                   # SPA (SolidJS) — только UI, TypeScript на крайняк
├── backend/                    # API — Rust (Axum)
├── packages/
│   ├── core/                   # ядро — Rust (типы, логика)
│   └── ui/                     # компоненты — TS только для фронта
├── docs/                       # MODEL.md, ARCHITECTURE.md, STACK.md, …
└── android/                    # Capacitor
```

Подробно про языки: **[STACK.md](./STACK.md)** — приоритет Rust, TypeScript только для фронта.

- **pages/** — только сборка экрана из `features` и `@security/ui`. Тяжёлую логику и данные — в `features/*` или API.
- **features/** — один каталог на фичу (verification, account-security, orders, guards). Внутри: компоненты фичи, хуки, запросы к API. Каждый feature можно подключать лениво (lazy route).
- **domains/** — только типы (TypeScript-интерфейсы), константы статусов, без логики. Используются и в `web`, и при расширении — в других приложениях или бэкенде (по контракту).
- **shared/** — i18n (ключи, текущий язык, загрузчик локалей), **единый API-клиент** (`shared/api.ts`), хелперы.

Так архитектура остаётся гибкой: новые фичи = новый каталог в `features/` и при необходимости новые типы в `domains/`, без раздувания существующих файлов.

**Контракт API:** все эндпоинты и форматы ответов описаны в **[API_CONTRACT.md](./API_CONTRACT.md)**. Изменения в API — сначала туда, затем бэкенд и `shared/api.ts`.

---

## 3. Языки (i18n)

- **Языки:** RU (по умолчанию), EN, FR (Sénégal) — как в продукте.
- **Структура ключей по доменам:**  
  `verification.*`, `account.*`, `orders.*`, `guards.*`, `common.*`. Так проще масштабировать и не смешивать всё в одном файле.
- **Реализация:** один модуль в `shared/i18n`: текущий язык, смена языка, функция `t(namespace.key)`. Локали — JSON по одному на язык, при необходимости подгружать по имени языка (lazy). Страницы и фичи не хардкодят строки — только ключи.
- **Роутинг и язык:** при росте можно завести префикс локали в URL (`/ru/...`, `/en/...`) или хранить язык в настройках/профиле и подставлять в API (Accept-Language / query).

Язык и домены учитываются сразу, чтобы потом не переписывать экраны.

---

## 4. Домены и границы

| Домен | Ответственность | Где типы | Где UI/логика |
|-------|------------------|----------|----------------|
| **Guards** | Охранники, карточки, поиск, деталка | `domains/guards` | `features/guards`, `pages/GuardsPage`, `GuardDetailPage` |
| **Orders** | Заказы, статусы, назначение | `domains/orders` | `features/orders`, `pages/OrdersPage` |
| **Verification** | Верификация, фото, документы, дипломы | `domains/verification` | `features/verification` |
| **Account** | Профиль, безопасность, сессии, 2FA | `domains/account` | `features/account`, `pages/ProfilePage` |
| **Firm/Contract** | Фирма, контракты агент–фирма | `domains/contract` | `features/contract` (при появлении) |

Новые домены добавляются каталогом в `domains/` и при необходимости — каталогом в `features/` и маршрутами. Общие сущности (User, Guard, Order) импортируются из `domains/*`, а не дублируются.

Документация по доменам:
- **Верификация, фото, документы, дипломы** — [VERIFICATION.md](./VERIFICATION.md).
- **Безопасность аккаунта** — [ACCOUNT_SECURITY.md](./ACCOUNT_SECURITY.md).

---

## 5. Масштабирование без перегруза

- **Новые экраны:** новый файл в `pages/` и при необходимости папка в `features/`. Страница импортирует из `features` и `domains`, а не тянет всю логику в себя.
- **Новые языки:** новый JSON в `shared/i18n/locales/` и запись в список языков. Ключи по доменам уже заложены.
- **Новые типы документов/верификации:** расширяем контракты в `domains/verification` и при необходимости API. Подробно — в VERIFICATION.md.
- **Бэкенд (Rust):** контракты задаём в Rust; фронт (TS) только потребляет API.

Итог: архитектура рассчитана на то, что приложение станет «очень мощным» — за счёт доменов, фич и языков, а не за счёт роста одного и того же файла.

---

## 6. Правила без перегруза (надёжность на долго)

| Правило | Зачем |
|--------|--------|
| **Один файл — одна зона ответственности** | Страница не содержит типов домена и не дублирует вызовы API. Типы — из `domains/*`, запросы — из `shared/api.ts`. |
| **Бэкенд: тонкий main** | Точка входа только собирает роутер и запускает сервер. Обработчики — в `handlers.rs`, конфиг — в `config.rs`. Так проще тесты и смена транспорта. |
| **Конфиг из env** | Порт и хост бэкенда — через `SECURITY_PORT`, `SECURITY_HOST`. Без хардкода, готово к деплою. |
| **Новый эндпоинт = контракт + клиент** | Добавили маршрут в Rust — описали в API_CONTRACT.md и при необходимости функцию в `shared/api.ts`. |
| **Новый домен = types в domains/** | Интерфейсы и константы — в `domains/<name>.ts`, реэкспорт в `domains/index.ts`. Страницы и фичи только импортируют. |

Соблюдая это, можно годами наращивать функциональность без «перегруза» файлов и без поломки границ между слоями.

---

## 7. Приоритеты развития (не забываем)

При любых обновлениях и доработках держим в фокусе:

| Приоритет | Что значит |
|-----------|------------|
| **Развитие** | Новые фичи — по документированной структуре (features, domains, API). Обновления — инкрементально, без ломания существующего. |
| **Качество** | Чистый код, линт, типы, тесты по мере роста. Рефакторинг при накоплении долга. |
| **Безопасность** | Верификация, аккаунт, данные — отдельные домены (см. VERIFICATION.md, ACCOUNT_SECURITY.md). Без хардкода секретов, конфиг из env. |
| **Дизáйн** | Единые токены (packages/ui), доступность (зоны нажатия, контраст), тема светлая/тёмная. Новые экраны — в том же стиле. |
| **Архитектура** | Слои и границы из этого документа. Один API-клиент, типы в domains, тонкий main на бэкенде. |
| **Скорость** | Ленивые маршруты для тяжёлых фич, лёгкий бандл, быстрый ответ API. Не раздувать главный бандл и не блокировать UI. |

Итог: обновления по развитию, качеству, безопасности и дизайну делаем, не забывая про архитектуру и скорость.
