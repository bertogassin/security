# Модель приложения Security: клиент, агент, фирма

## Роли

1. **Клиент** — ищет охранника (агента) на заказ.
2. **Агент (охранник)** — сотрудник или привлечённый специалист; может соглашаться на заказы, подписывать контракт с фирмой.
3. **Фирма (охранное предприятие)** — нанимает охранников, заключает контракты с клиентами. **Владелец фирмы** может сам работать охранником — таких много.

Все участники, кто **онлайн**, участвуют в синхронизации: заявки, согласия, контракты, назначения.

---

## Два сценария (всё в онлайне)

### Сценарий A: Клиент ищет агента

1. **Клиент** создаёт заказ (адрес, тип услуги, время).
2. Заказ виден **онлайн-агентам** и/или **фирме**.
3. **Агент** соглашается на заказ (принимает заявку).
4. Далее:
   - **Агент уже в штате** → фирма фиксирует назначение (внутренний контракт/приказ уже есть).
   - **Агент привлечённый** → агент подписывает контракт с фирмой (разовый/рамочный), затем фирма формально назначает его на этот заказ клиенту.
5. Клиент видит: «Охранник принял заказ», при необходимости — «Подписание контракта с фирмой».
6. Статусы синхронизируются у всех: клиент, агент, фирма.

### Сценарий B: Фирма находит клиента и нанимает охранника

1. **Фирма** получает заявку от клиента (сайт, звонок, партнёры) или сама находит клиента.
2. Фирма создаёт заказ в системе и подбирает **онлайн-охранника** (агента):
   - из своих штатных,
   - или приглашает внешнего — тот подписывает контракт с фирмой, потом назначается на заказ.
3. **Владелец фирмы** может назначить **сам себя** охранником на заказ — он и владелец, и агент в одном лице (таких много).
4. Клиенту показывается назначенный охранник; статусы обновляются у всех сторон.

---

## Синхронизация (кто онлайн)

- **Клиент онлайн** — видит список доступных охранников, статус заказа, назначение, контракт (если показываем).
- **Агент онлайн** — видит входящие заказы, кнопка «Согласен»; после согласия — экран подписания контракта с фирмой (если нужно); далее — «Мой заказ», маршрут, чат с клиентом.
- **Фирма (диспетчер/владелец) онлайн** — видит заказы клиентов, список онлайн-агентов, назначает агента на заказ или подтверждает самовызов агента; видит контракты (агент–фирма); владелец может сам взять заказ как агент.

Общие сущности для синхронизации:

- **Заказ** — создан клиентом или фирмой; статусы: новый → агент согласился → контракт агент–фирма (если нужен) → назначен → в работе → выполнен.
- **Контракт агент–фирма** — разовый или рамочный; подписание онлайн (электронная подпись / согласие).
- **Назначение** — заказ ↔ агент; кто назначил (клиент через систему, или фирма).

---

## Владелец фирмы = охранник

- У фирмы есть **владелец** (аккаунт).
- Владелец может быть в списке **агентов**: «доступен как охранник».
- Когда владелец онлайн и свободен, он видит те же заказы, что и другие агенты, и может **сам взять заказ** (согласиться).
- Контракт с фирмой для владельца не нужен (он и есть фирма) — в логике это «штатный, без отдельного контракта на этот заказ».
- В интерфейсе: переключатель «Я как владелец» / «Я как охранник» или один экран с заказами и кнопкой «Взять в работу» для себя.

---

## Кратко для разработки

| Кто       | Действие в онлайне |
|----------|---------------------|
| Клиент   | Создаёт заказ, видит охранников, видит назначение и статус. |
| Агент    | Видит заказы, «Согласен», подписание контракта с фирмой (если не штатный), «Мой заказ», маршрут, чат. |
| Фирма    | Видит заказы и онлайн-агентов, назначает агента или подтверждает самовызов; владелец может взять заказ сам. |
| Синхрон  | Заказ, статусы, назначение, контракт (агент–фирма) — общая модель данных и события для всех ролей. |

Это и есть идея: клиент ищет агента → агент соглашается → контракт с фирмой (если нужно) или фирма сама находит клиента и нанимает охранника; владелец фирмы тоже может работать охранником; всё синхронизируется для тех, кто онлайн.

---

## Порядок и алгоритм: клиент → агент → фирма (документы уже поданы)

Главное: **сначала клиент делает заказ**, потом **охранник принимает**, а **фирмы заранее подали документы и согласия** — так алгоритм может выбрать, какой агент будет работать на их фирму.

### Последовательность

1. **Клиент** создаёт заказ охранника (адрес, услуга, время).
2. **Охранник (агент)** принимает заказ (соглашается).
3. **Фирмы** к этому моменту уже подали в систему **документы и согласия** на то, что алгоритм выбирает агента для работы на их фирме.
4. **Алгоритм** видит:
   - свободного агента (с документами),
   - заказ клиента,
   - фирмы с документами и согласием.
   Алгоритм **автоматически** определяет соответствие и даёт возможность выбрать/назначить агента.
5. **Фирма** получает **уведомление об агенте** (агент тоже с документами) и может дальше вести свою работу.
6. Итог: **свободный агент + клиент** — и всё становится на свои места.

### Конфиденциальность: кто что видит

| Кто видит | Что видно |
|-----------|-----------|
| **Клиент** | Свой заказ, назначенного охранника, статус. **Не видит**: цены фирм, задания/регистрации других охранников. |
| **Охранники** | Свои заказы, задания. **Не видят**: цены фирм, задания других агентов. |
| **Фирмы** | Свои заявки, уведомление о назначенном агенте (с документами). **Не видят**: цены других фирм, регистрации заданий охранников. |
| **Алгоритм** | Цены фирм, задания охранников, документы и согласия. Сопоставляет соответствия и **автоматически** выбирает/назначает агента. |

Цены фирм и регистрации заданий охранников **не видны ни клиенту, ни друг другу** — только алгоритм использует эти данные для подбора. Фирма после уведомления об агенте продолжает работу, зная, что агент верифицирован (документы).
